<!DOCTYPE html>
<html>
<head>
    <title>Open Diagram</title>
    <link rel="stylesheet" type="text/css" href="styles/logicdesigner.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<script type="text/javascript">
deletedIDS=[];
changedNames=[];
	// Reads files locally using js
  	var storedShapes = JSON.parse(localStorage.getItem('storedShapes'));

	// Handles form-submit by preparing to process response
	function handleSubmit(){
		window.parent.openFile.setData(storedShapes);
	}

	// Hides this dialog
	function hideWindow(cancel){
		window.parent.openFile.cancel(cancel);
	}

	function removeFile(id){
		document.getElementById('fileRow-'+id).innerHTML = "";
		var new_shapes = new Array();
		for (var  i=0; i<storedShapes.length; i++) {
			if (i!=id) 
				new_shapes.push(storedShapes[i]);
		}
		storedShapes = new_shapes;
	}


  	function nameIsUsed(id,name){
	for (var i=0; i<storedShapes.length; i++) {
		if((i!=id) && (name==storedShapes[i].componentName))
			return true;
	}
	return false;
    }
	function isAlpha(c){
		return /^[A-Z]$/i.test(c);
	}
	function nameIsValid(id,name){
		var return_val = true;
		if ( (!isAlpha(name[0])) && (name[0]!='_') ) 
			return_val = false;
		if ( name.includes(' ') ) 
			return_val = false;
		return return_val;
	}
    function changeFileName(id,newName){
		if ( nameIsUsed(id,newName) ){
			alert('"'+ newName +'" already exists. Please change the name.');
		}
		else if ( !nameIsValid(id,newName) ) {
			alert('"'+ newName +'" is invalid. Please change the name.');
			console.log("alert");
		}
		else {
			storedShapes[id].componentName = newName;
		}
    }


	function main(){	
		if (window.parent.Editor.useLocalStorage)
		{
			document.body.innerHTML = '';
			var div = document.createElement('div');
			div.style.fontFamily = 'Arial';

			if (localStorage.length == 0)
			{
				window.parent.mxUtils.write(div, window.parent.mxResources.get('noFiles'));
			}
			else
			{
				var keys = [];

				for (var i = 0; i < localStorage.length; i++)
				{
					keys.push(localStorage.key(i));
				}

				// Sorts the array by filename (key)
				keys.sort(function (a, b)
				{
				    return a.toLowerCase().localeCompare(b.toLowerCase());
				});

				for (var i = 0; i < keys.length; i++)
				{
					var link = document.createElement('a');
					link.style.fontDecoration = 'none';
					link.style.fontSize = '14pt';
					var key = keys[i];
					window.parent.mxUtils.write(link, key);
					link.setAttribute('href', 'javascript:void(0);');
					div.appendChild(link);

					var img = document.createElement('span');
					img.className = 'geSprite geSprite-delete';
					img.style.position = 'relative';
					img.style.cursor = 'pointer';
					img.style.display = 'inline-block';
					div.appendChild(img);

					window.parent.mxUtils.br(div);

					window.parent.mxEvent.addListener(img, 'click', (function(k)
					{
						return function()
						{
							if (window.parent.mxUtils.confirm(window.parent.mxResources.get('delete') + ' "' + k + '"?'))
							{
								localStorage.removeItem(k);
								window.location.reload();
							}
						};
					})(key));
					
					window.parent.mxEvent.addListener(link, 'click', (function(k)
					{
						return function()
						{
							try
							{
								window.parent.open(window.parent.location.href);
								window.parent.openFile.setData(localStorage.getItem(k), k);
							}
							catch (e)
							{
								window.parent.mxUtils.alert(e.message);
							}
						};
					})(key));
				}
			}

			window.parent.mxUtils.br(div);
			window.parent.mxUtils.br(div);

			var cancelBtn = window.parent.mxUtils.button(window.parent.mxResources.get('cancel'), function()
			{
				hideWindow(true);
			});
			cancelBtn.className = 'geBtn';
			div.appendChild(cancelBtn);

			document.body.appendChild(div);
		}
		else
		{
			var output="";
			var i;
			if (storedShapes!=null && storedShapes.length>0) {
				for (i=0; i<storedShapes.length; i++) {
					output += '<tr id="fileRow-'+i+'"> <td>'+(i+1)+'. </td> <td colspan="2" > <input style="width:100%" type="text" name="" onchange="changeFileName('+i+',this.value)" value="'+storedShapes[i].componentName+'"></td> <td><input type="button" value="X" onclick="removeFile('+i+')"></td> </tr>'
				}
			}
			document.getElementById("allFileNames").innerHTML = output;
		}
	};
</script>
<body onload="main();">
<form enctype="multipart/form-data" action="" onsubmit="return handleSubmit();" accept-charset="UTF-8">
<table style="width:100%;">
<tr>
<td style="vertical-align:top;" colspan="2">
</td>
</tr>
<tr>
<td colspan="2" height="" id="importSupported" style="font-family:arial;color:grey;font-size:9pt;vertical-align:top;text-align:left;">
</td>
</tr>
<tr>
  <table id="allFileNames" style="font-family:arial;color:grey;font-size:9pt;vertical-align:top;text-align:left;">
  </table>
</tr>
<tr>
<td>
</td>
<td style="margin-top: 10px;vertical-align:middle;text-align:right;white-space:nowrap;">
<input type="button" id="cancelButton" class="geBtn" value="Cancel" onclick="hideWindow(true);">
<input type="submit" id="saveButton" class="geBtn gePrimaryBtn" value="Save">
</td>
</tr>
</table>
</form>
</body>
</html>
