<!--
  Created by 2020 [WCP28] Jacob Richman, Tomer Itzhaki, Xuan Do; Advisor: Meghana Jain
  Updated by 2021 [ECD106] Charlie Shames, Thomas Nicolino, Ben Picone, Joseph Luciano; Advisor: Meghana Jain 
-->
<!DOCTYPE html>
<html>
<head>
    <title>Open Diagram</title>
    <link rel="stylesheet" type="text/css" href="styles/logicdesigner.css" />
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
</head>
<script type="text/javascript">
	deletedIDS=[];
	changedNames=[];
	var ui = this.editorUi;
	// Reads files locally using js
  	var storedShapes = JSON.parse(localStorage.getItem('storedShapes'));

	function handleFiles(files)
	{
    //temporarily save file name and verilog for each file
    localStorage.setItem('storedTMPShape', JSON.stringify([]));
		for (var i = 0; i < files.length; i++)
		{
      if (!deletedIDS.includes(i)){
  			(function(file)
  			{
  				// Small hack to support import
  				if (window.parent.openNew)
  				{
  					window.parent.open(window.parent.location.href);
  				}
          var name = file.name
          if (changedNames[i]){name = changedNames[i]}

  				var reader = new FileReader();
  				reader.onload = function(e)
  				{
            var bin = e.target.result

            var storedTMPShape = JSON.parse(localStorage.getItem('storedTMPShape'));
            storedTMPShape.push({
              "name":name,
              "verilog":bin
            });
            localStorage.setItem('storedTMPShape', JSON.stringify(storedTMPShape));
            functionCheckIfLastUpload(files.length-deletedIDS.length)
  				};
  				reader.onerror = function(e)
  				{
  					console.log(e);
  				};
  				reader.readAsText(file);
  			})(files[i]);
      }
		}
	};

  	function functionCheckIfLastUpload(size){
		var storedTMPShape = JSON.parse(localStorage.getItem('storedTMPShape'));
		if (storedTMPShape.length == size){
		window.parent.openFile.setData(storedTMPShape);
		}
  	}
	function checkVerilogIdentifier(newstr){
		function isAlpha(c){
			return /^[A-Z]$/i.test(c);
		}
		if( newstr.length > this.maxPortnameLength )
			return false;
		if( !isAlpha(newstr[0]) && newstr[0]!='_' || newstr.includes(" ") ) 
			return false;
		//if( this.isVerilogReserved(newstr) )
		//	return false;
		return true;
	};

	// Handles form-submit by preparing to process response
	function handleSubmit()
	{
		var form = window.openForm || document.getElementById('openForm');

		// Checks for support of the File API for local file access
		// except for files where the parse is on the server
		if (window.parent.Graph.fileSupport && form.upfile.files.length > 0)
		{
			handleFiles(form.upfile.files);

			return false;
		}
		else
		{
			if (/(\.xml)$/i.test(form.upfile.value) || /(\.txt)$/i.test(form.upfile.value) ||
				/(\.mxe)$/i.test(form.upfile.value))
			{
				// Small hack to support import
				if (window.parent.openNew)
				{
					window.parent.open(window.parent.location.href);
				}

				// NOTE: File is loaded via JS injection into the iframe, which in turn sets the
				// file contents in the parent window. The new window asks its opener if any file
				// contents are available or waits for the contents to become available.
				return true;
			}
			else
			{
				window.parent.mxUtils.alert(window.parent.mxResources.get('invalidOrMissingFile'));

				return false;
			}
		}
	};

	// Hides this dialog
	function hideWindow(cancel)
	{
		window.parent.openFile.cancel(cancel);
	}

 	function removeFile(id){
    	document.getElementById('fileRow-'+id).innerHTML = "";
    	deletedIDS.push(id)
  	}

    function nameIsUsed(id,name){
	for (var i=0; i<storedShapes.length; i++) {
		if((i!=id) && (name==storedShapes[i].componentName))
			return true;
	}
	return false;
    }
	function isNativeComponent ( component ){
		var native_components=["and", "nand", "or","nor","xor","xnor","buf", "inverter",
					"mux2","mux4", "mux8","mux16",
					"decoder2","decoder3","decoder4",
					"dff", "dff_en", "srlatch", "srlatch_en", "dlatch", "dlatch_en", 
					"fanIn2",  "fanIn4",  "fanIn8",  "fanIn16",  "fanIn32",
					"fanOut2",  "fanOut4", "fanOut8", "fanOut16", "fanOut32",
					"inputport1", "inputport2", "inputport4", "inputport8", "inputport16", "inputport32",
					"outputport1", "outputport2", "outputport4", "outputport8", "outputport16", "outputport32",
					"constant0", "constant1" ];
		return native_components.includes( component );
	};
  	function changeFileName(id,newName){
		changedNames[id] = newName;
		var invalid_id = false;
		var isExistingFile = false;
		//check for duplicates
		var form = window.openForm || document.getElementById('openForm');
		var files = form.upfile.files;
		var used_names = new Set();;
		for (var i = 0; i < files.length; i++){
			(function(file){
				var name = file.name;
				if (changedNames[i]){name = changedNames[i]}
				if ( !deletedIDS.includes(i) ) {
					for (existingfile in storedShapes){
						if (storedShapes[existingfile].componentName == name.replace(".v", "") || isNativeComponent(name.replace(".v", "")) ){
							isExistingFile = true;
							used_names.add( name.replace(".v", "") );
						}
						if ( !checkVerilogIdentifier(name) )
							invalid_id = true;
					}
				}
			})(files[i]);
		}
		if (invalid_id)
			alert('Module names must start with a letter or _ and may not contain whitespace.');
		if (used_names.size)
			used_names.forEach(function(name){alert('"'+name +'" already exists. Please change the name.');});
		if ( !isExistingFile && !invalid_id )//enable
			openButton.removeAttribute('disabled');
		else//disable
			openButton.setAttribute('disabled', 'disabled');
  	}

  //file name change window
	function fileChanged()
	{
    var form = window.openForm || document.getElementById('openForm');
    var files = form.upfile.files;
	var disable_open = false;
    var output = "";

    var isExistingFile = false;

    //build the table of file names
    for (var i = 0; i < files.length; i++){
			(function(file)
			{
        for (existingfile in storedShapes){
          if (storedShapes[existingfile].componentName == file.name.replace(".v", "")){
            isExistingFile = true;
            alert('"'+file.name +'" already exists. Please change the name.');
          }
		  else if ( !checkVerilogIdentifier(file.name) ){
			disable_open = true;
		  }
        }
		output += '<tr id="fileRow-'+i+'"> <td>'+(i+1)+'. </td> <td colspan="2" > <input style="width:100%" type="text" name="" onchange="changeFileName('+i+',this.value)" value="'+file.name+'"></td> <td><input type="button" value="X" onclick="removeFile('+i+')"></td> </tr>'
			})(files[i]);
    }

    document.getElementById("allFileNames").innerHTML = output;
    //******for each file, show an optional renaming box******
	var form = window.openForm || document.getElementById('openForm');
	var openButton = document.getElementById('openButton');

	if (disable_open)
		alert('Module names must start with a letter or _ and may not contain whitespace.');

	//enable and disable the submit button
	if (form.upfile.value.length > 0 && !isExistingFile && !disable_open ) 
		openButton.removeAttribute('disabled');
	else
		openButton.setAttribute('disabled', 'disabled');
	}

	function main()
	{	
		if (window.parent.Editor.useLocalStorage)
		{
			document.body.innerHTML = '';
			var div = document.createElement('div');
			div.style.fontFamily = 'Arial';

			if (localStorage.length == 0)
			{
				window.parent.mxUtils.write(div, window.parent.mxResources.get('noFiles'));
			}
			else
			{
				var keys = [];

				for (var i = 0; i < localStorage.length; i++)
				{
					keys.push(localStorage.key(i));
				}

				// Sorts the array by filename (key)
				keys.sort(function (a, b)
				{
				    return a.toLowerCase().localeCompare(b.toLowerCase());
				});

				for (var i = 0; i < keys.length; i++)
				{
					var link = document.createElement('a');
					link.style.fontDecoration = 'none';
					link.style.fontSize = '14pt';
					var key = keys[i];
					window.parent.mxUtils.write(link, key);
					link.setAttribute('href', 'javascript:void(0);');
					div.appendChild(link);

					var img = document.createElement('span');
					img.className = 'geSprite geSprite-delete';
					img.style.position = 'relative';
					img.style.cursor = 'pointer';
					img.style.display = 'inline-block';
					div.appendChild(img);

					window.parent.mxUtils.br(div);

					window.parent.mxEvent.addListener(img, 'click', (function(k)
					{
						return function()
						{
							if (window.parent.mxUtils.confirm(window.parent.mxResources.get('delete') + ' "' + k + '"?'))
							{
								localStorage.removeItem(k);
								window.location.reload();
							}
						};
					})(key));

					window.parent.mxEvent.addListener(link, 'click', (function(k)
					{
						return function()
						{
							try
							{
								window.parent.open(window.parent.location.href);
								window.parent.openFile.setData(localStorage.getItem(k), k);
							}
							catch (e)
							{
								window.parent.mxUtils.alert(e.message);
							}
						};
					})(key));
				}
			}

			window.parent.mxUtils.br(div);
			window.parent.mxUtils.br(div);

			var cancelBtn = window.parent.mxUtils.button(window.parent.mxResources.get('cancel'), function()
			{
				hideWindow(true);
			});
			cancelBtn.className = 'geBtn';
			div.appendChild(cancelBtn);

			document.body.appendChild(div);
		}
		else
		{
			var editLink = document.getElementById('editLink');
			var openButton = document.getElementById('openButton');
			openButton.value = window.parent.mxResources.get(window.parent.openKey || 'open');
			var cancelButton = document.getElementById('cancelButton');
			cancelButton.value = window.parent.mxResources.get('cancel');
			var supportedText = document.getElementById('importSupported');
			supportedText.innerHTML = window.parent.mxResources.get('importSupported');
			var form = window.openForm || document.getElementById('openForm');
			form.setAttribute('action', window.parent.OPEN_URL);
		}
	};
</script>
<body onload="main();">
<form method="POST" enctype="multipart/form-data" action="" name="openForm"
	id="openForm" onsubmit="return handleSubmit();" accept-charset="UTF-8">
<table style="width:100%;">
<tr>
<td style="vertical-align:top;" colspan="2">
<input type="file" name="upfile" multiple onchange="fileChanged()">
</td>
</tr>
<tr>
<td colspan="2" height="" id="importSupported" style="font-family:arial;color:grey;font-size:9pt;vertical-align:top;text-align:left;">
</td>
</tr>
<tr>
  <table id="allFileNames" style="font-family:arial;color:grey;font-size:9pt;vertical-align:top;text-align:left;">
  </table>
</tr>
<tr>
<td>
</td>
<td style="margin-top: 10px;vertical-align:middle;text-align:right;white-space:nowrap;">
<input type="button" id="cancelButton" class="geBtn" value="Cancel" onclick="hideWindow(true);">
<input type="submit" id="openButton" class="geBtn gePrimaryBtn" value="Open" disabled="disabled">
</td>
</tr>
</table>
</form>
</body>
</html>
